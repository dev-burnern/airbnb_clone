name: CI/CD

on:
  push:
    branches: ["main", "dev"]
  pull_request:
    branches: ["main", "dev"]
  workflow_dispatch:

jobs:
  frontend:
    name: Frontend CI/CD
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: frontend  # í”„ë¡ íŠ¸ì—”ë“œ ê²½ë¡œ ì§€ì •

    steps:
      - name: âœ… Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js (Frontend)
        uses: actions/setup-node@v4
        with:
          node-version: 20.19
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: ğŸ“¦ Install dependencies (Frontend)
        run: npm ci

      - name: ğŸ” ESLint (Frontend)
        run: npm run lint

      - name: ğŸ§ª Jest tests (Frontend)
        run: |
          if [ -f package.json ] && cat package.json | grep -q "\"test\""; then
            npm test -- --ci
          else
            echo "no test script, skipping"
          fi

      - name: ğŸ— Build Next.js (Frontend)
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
        run: npm run build

      - name: ğŸ³ Build Docker image (Frontend)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/frontend:latest .

      - name: ğŸ”‘ Docker Hub Login (Frontend)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ“¤ Push Docker image (Frontend)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/frontend:latest

      - name: ğŸš€ Deploy Frontend on EC2
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/frontend:latest
            docker stop frontend || true
            docker rm frontend || true
            docker run -d --name frontend -p 3000:3000 \
              --env NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }} \
              ${{ secrets.DOCKERHUB_USERNAME }}/frontend:latest

  backend:
    name: Backend CI/CD
    runs-on: ubuntu-latest
    needs: frontend  # í”„ë¡ íŠ¸ì—”ë“œê°€ ë¨¼ì € ëë‚˜ì•¼ ì‹¤í–‰, í•„ìš” ì—†ìœ¼ë©´ ì‚­ì œ ê°€ëŠ¥

    defaults:
      run:
        working-directory: backend  # ë°±ì—”ë“œ ê²½ë¡œ ì§€ì •

    steps:
      - name: âœ… Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js (Backend)
        uses: actions/setup-node@v4
        with:
          node-version: 20.19
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: ğŸ“¦ Install dependencies (Backend)
        run: npm ci

      - name: ğŸ” ESLint (Backend)
        run: npm run lint

      - name: ğŸ§ª Jest tests (Backend)
        run: |
          if [ -f package.json ] && cat package.json | grep -q "\"test\""; then
            npm test -- --ci
          else
            echo "no test script, skipping"
          fi

      - name: ğŸ— Build Nest.js (Backend)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: npm run build

      - name: ğŸ³ Build Docker image (Backend)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/backend:latest .

      - name: ğŸ”‘ Docker Hub Login (Backend)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ“¤ Push Docker image (Backend)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/backend:latest

      - name: ğŸš€ Deploy Backend on EC2
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/backend:latest
            docker stop backend || true
            docker rm backend || true
            docker run -d --name backend -p 4000:4000 \
              --env DATABASE_URL=${{ secrets.DATABASE_URL }} \
              --env JWT_SECRET=${{ secrets.JWT_SECRET }} \
              ${{ secrets.DOCKERHUB_USERNAME }}/backend:latest